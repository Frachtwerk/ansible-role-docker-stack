---
# Create a Docker configuration for Fluent Bit
- name: Create docker configuration for Fluent Bit
  community.docker.docker_config:
    name: fluentbit
    data: |
      [OUTPUT]
        Name              loki
        Match             **
        host              {{ docker_fluentbit_loki_host }}
        port              {{ docker_fluentbit_loki_port }}
        labels            {job="service"}
# Start Fluent Bit container
- name: Start Fluent Bit container
  community.docker.docker_container:
    name: fluent-bit
    image: "{{ docker_fluentbit_image }}:{{ docker_fluentbit_version }}"
    state: started
    restart_policy: always
    configs:
      - source: fluentbit
        target: /fluent-bit/etc/fluent-bit.conf
# Create Docker daemon configuration for Fluent Bit
- name: Create docker daemon configuration for Fluent Bit
  ansible.builtin.copy:
    dest: /tmp/fluentbit.daemon.json
    content: |
      {
        "log-driver": "fluentd",
        "log-opts": {
          "fluentd-address": "fluent-bit:24224",
          "tag": "docker.{{.Name}}.{{.ID}}"
        }
      }
    mode: '0644'
    owner: root
    group: root
  become: true
# Ensure /etc/docker/daemon.json exists
- name: Ensure /etc/docker/daemon.json exists
  ansible.builtin.file:
    path: /etc/docker/daemon.json
    state: touch
  become: true
# Merge Fluent Bit configuration into Docker daemon.json
- name: Merge Fluent Bit configuration into Docker daemon.json
  ansible.builtin.command:
    cmd: >
      jq -s 'add' /etc/docker/daemon.json /tmp/fluentbit.daemon.json > /tmp/daemon.json && mv /tmp/daemon.json /etc/docker/daemon.json
  become: true
# Remove temporary Fluent Bit daemon configuration file
- name: Remove temporary Fluent Bit daemon configuration file
  ansible.builtin.file:
    path: /tmp/fluentbit.daemon.json
    state: absent
  become: true
# Restart Docker service to apply Fluent Bit configuration
- name: Restart Docker service to apply Fluent Bit configuration
  ansible.builtin.systemd:
    name: docker
    state: restarted
  become: true
